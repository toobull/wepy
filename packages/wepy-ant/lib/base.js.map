{"version":3,"sources":["../src/base.js"],"names":["PAGE_EVENT","APP_EVENT","$bindEvt","config","com","prefix","$prefix","util","camelize","Object","getOwnPropertyNames","components","forEach","name","cClass","child","$initMixins","$name","comPrefix","$com","constructor","prototype","prop","indexOf","apply","arguments","$apply","allMethods","methods","$mixins","mix","concat","method","i","e","args","evt","event","type","$transfor","wepyParams","paramsLength","tmp","p","comIndex","currentTarget","dataset","toLowerCase","String","fromCharCode","undefined","push","split","level","length","tmpcom","$parent","$setIndex","shift","rst","mixRst","comfn","$createApp","appClass","appConfig","app","$instance","$init","$app","$wxapp","getApp","v","$createPage","pageClass","pagePath","self","k","page","$pages","$page","onLoad","prevPage","__prevPage__","secParams","from","keys","$preloadData","preload","$prefetchData","prefetch","onShow","pages","getCurrentPages","pageId","__route__","onRoute","onShareAppMessage"],"mappings":"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","file":"base.js","sourcesContent":["/**\n * Tencent is pleased to support the open source community by making WePY available.\n * Copyright (C) 2017 THL A29 Limited, a Tencent company. All rights reserved.\n *\n * Licensed under the MIT License (the \"License\"); you may not use this file except in compliance with the License. You may obtain a copy of the License at\n * http://opensource.org/licenses/MIT\n * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.\n */\n\n\nimport event from './event';\nimport util from './util';\n\nconst PAGE_EVENT = ['onLoad', 'onReady', 'onShow', 'onHide', 'onUnload', 'onPullDownRefresh', 'onReachBottom', 'onShareAppMessage'];\nconst APP_EVENT = ['onLaunch', 'onShow', 'onHide', 'onError'];\n\n\nlet $bindEvt = (config, com, prefix) => {\n    com.$prefix = util.camelize(prefix || '');\n    Object.getOwnPropertyNames(com.components || {}).forEach((name) => {\n        let cClass = com.components[name];\n        let child = new cClass();\n        child.$initMixins();\n        child.$name = name;\n        let comPrefix = prefix ? (prefix + child.$name + '$') : ('$' + child.$name + '$');\n\n        com.$com[name] = child;\n\n        $bindEvt(config, child, comPrefix);\n    });\n    Object.getOwnPropertyNames(com.constructor.prototype || []).forEach((prop) => {\n        if(prop !== 'constructor' && PAGE_EVENT.indexOf(prop) === -1) {\n            config[prop] = function () {\n                com.constructor.prototype[prop].apply(com, arguments);\n                com.$apply();\n            }\n        }\n    });\n\n    let allMethods = Object.getOwnPropertyNames(com.methods || []);\n\n    com.$mixins.forEach((mix) => {\n        allMethods = allMethods.concat(Object.getOwnPropertyNames(mix.methods || []));\n    });\n\n    allMethods.forEach((method, i) => {\n        config[com.$prefix + method] = function (e, ...args) {\n            e = e || {}\n            let evt = new event('system', this, e.type);\n            evt.$transfor(e);\n            let wepyParams = [], paramsLength = 0, tmp, p, comIndex;\n            if (e.currentTarget && e.currentTarget.dataset) {\n                tmp = e.currentTarget.dataset;\n                while(tmp['wpy' + method.toLowerCase() + (p = String.fromCharCode(65 + paramsLength++))] !== undefined) {\n                    wepyParams.push(tmp['wpy' + method.toLowerCase() + p]);\n                }\n                if (tmp.comIndex !== undefined) {\n                    comIndex = tmp.comIndex;\n                }\n            }\n\n            // Update repeat components data.\n            if (comIndex !== undefined) {\n                comIndex = ('' + comIndex).split('-');\n                let level = comIndex.length, tmp = level;\n                while(level-- > 0) {\n                    tmp = level;\n                    let tmpcom = com;\n                    while (tmp-- > 0) {\n                        tmpcom = tmpcom.$parent;\n                    }\n                    tmpcom.$setIndex(comIndex.shift());\n                }\n            }\n\n            args = [].concat(wepyParams);\n            let rst, mixRst;\n            let comfn = com.methods[method];\n            if (comfn) {\n                rst = comfn.apply(com, args.concat(evt));\n            }\n            com.$mixins.forEach((mix) => {\n                mix.methods[method] && (mixRst = mix.methods[method].apply(com, args.concat(evt)));\n            });\n            com.$apply();\n            return comfn ? rst : mixRst;\n        }\n    });\n    return config;\n};\n\n\nexport default {\n    $createApp (appClass, appConfig) {\n        let config = {};\n        let app = new appClass();\n\n        if (!this.$instance) {\n            app.$init(this, appConfig);\n            this.$instance = app;\n        }\n\n        // This is for test case\n        if (arguments.length === 2 && arguments[1] === true) {\n            config.$app = app;\n        }\n\n        app.$wxapp = getApp();\n\n        APP_EVENT.forEach((v) => {\n            config[v] = (...args) => {\n                let rst;\n                app[v] && (rst = app[v].apply(app, args));\n                return rst;\n            };\n        });\n        return config;\n    },\n    $createPage (pageClass, pagePath) {\n        let self = this;\n        let config = {}, k;\n        let page = new pageClass();\n        if (typeof pagePath === 'string') {\n            this.$instance.$pages['/' + pagePath] = page;\n        }\n        page.$initMixins();\n        // This will be a circum Object\n        if ((typeof pagePath === 'boolean' && pagePath) || (arguments.length === 3 && arguments[2] === true))\n            config.$page = page;\n\n        config.onLoad = function (...args) {\n\n            page.$name = pageClass.name || 'unnamed';\n            page.$init(this, self.$instance, self.$instance);\n\n            let prevPage = self.$instance.__prevPage__;\n            let secParams = {};\n            secParams.from = prevPage ? prevPage : undefined;\n\n            if (prevPage && Object.keys(prevPage.$preloadData).length > 0) {\n                secParams.preload = prevPage.$preloadData;\n                prevPage.$preloadData = {};\n            }\n            if (page.$prefetchData && Object.keys(page.$prefetchData).length > 0) {\n                secParams.prefetch = page.$prefetchData;\n                page.$prefetchData = {};\n            }\n            args.push(secParams);\n            page.onLoad && page.onLoad.apply(page, args);\n\n            page.$mixins.forEach((mix) => {\n                mix['onLoad'] && mix['onLoad'].apply(page, args);\n            });\n\n            page.$apply();\n        };\n\n        config.onShow = function (...args) {\n\n            self.$instance.__prevPage__ = page;\n\n            page.onShow && page.onShow.apply(page, args);\n\n            page.$mixins.forEach((mix) => {\n                mix['onShow'] && mix['onShow'].apply(page, args);\n            });\n\n            let pages = getCurrentPages();\n            let pageId = pages[pages.length - 1].__route__;\n\n            if (self.$instance.__route__ !== pageId) {\n\n                self.$instance.__route__ = pageId;\n\n                page.onRoute && page.onRoute.apply(page, args);\n\n                page.$mixins.forEach((mix) => {\n                    mix['onRoute'] && mix['onRoute'].apply(page, args);\n                });\n            }\n\n            page.$apply();\n        };\n\n        PAGE_EVENT.forEach((v) => {\n            if (v !== 'onLoad' && v !== 'onShow') {\n                config[v] = (...args) => {\n                    let rst;\n                    page[v] && (rst = page[v].apply(page, args));\n\n                    if (v === 'onShareAppMessage')\n                        return rst;\n\n                    page.$mixins.forEach((mix) => {\n                        mix[v] && mix[v].apply(page, args);\n                    });\n\n                    page.$apply();\n\n                    return rst;\n                };\n            }\n        });\n\n        if (!page.onShareAppMessage) {\n            delete config.onShareAppMessage;\n        }\n\n        return $bindEvt(config, page, '');\n    },\n}\n"]}